/*
 * jQuery Mobile Framework : plugin to provide a dialogs Widget. ver2
 * Copyright (c) JTSage
 * CC 3.0 Attribution.  May be relicensed without permission/notifcation.
 * https://github.com/jtsage/jquery-mobile-simpledialog
 */

!function(e,t){e.widget("mobile.simpledialog2",e.mobile.widget,{options:{version:"1.0.1-2012061300",mode:"blank",themeDialog:"b",themeInput:!1,themeButtonDefault:!1,themeHeader:"a",fullScreen:!1,fullScreenForce:!1,dialogAllow:!1,dialogForce:!1,headerText:!1,headerClose:!1,buttonPrompt:!1,buttonInput:!1,buttonInputDefault:!1,buttonPassword:!1,blankContent:!1,blankContentAdopt:!1,resizeListener:!0,safeNuke:!0,forceInput:!0,showModal:!0,animate:!0,transition:"pop",clickEvent:"click",zindex:"500",width:"280px",left:!1,top:!1,callbackOpen:!1,callbackOpenArgs:[],callbackClose:!1,callbackCloseArgs:[]},_eventHandler:function(e,t){var n=e.data.widget;e.data.widget.options;if(!e.isPropagationStopped())switch(t.method){case"close":n.close();break;case"html":n.updateBlank(t.source);break}},_create:function(){var t=this,n=e.extend(this.options,this.element.jqmData("options")),i=new Date,o=e("<div class='ui-simpledialog-container ui-overlay-shadow ui-corner-all ui-simpledialog-hidden "+(!0===n.animate?n.transition:"")+" ui-body-"+n.themeDialog+"'></div>");!1===n.themeButtonDefault&&(n.themeButtonDefault=n.themeDialog),!1===n.themeInput&&(n.themeInput=n.themeDialog),e.mobile.sdCurrentDialog=t,void 0!==e.mobile.sdLastInput&&delete e.mobile.sdLastInput,t.internalID=i.getTime(),t.displayAnchor=e.mobile.activePage.children(".ui-content").first(),0===t.displayAnchor.length&&(t.displayAnchor=e.mobile.activePage),t.dialogPage=e("<div data-role='dialog' data-theme='"+n.themeDialog+"'><div data-role='header'></div><div data-role='content'></div></div>"),t.sdAllContent=t.dialogPage.find("[data-role=content]"),o.appendTo(t.sdAllContent),t.sdIntContent=t.sdAllContent.find(".ui-simpledialog-container"),t.sdIntContent.css("width",n.width),!1===n.headerText&&!1===n.headerClose||(t.sdHeader=e('<div style="margin-bottom: 4px;" class="ui-header ui-bar-'+n.themeHeader+'"></div>'),!0===n.headerClose&&e("<a class='ui-btn-left' rel='close' href='#'>Close</a>").appendTo(t.sdHeader).buttonMarkup({theme:n.themeHeader,icon:"delete",iconpos:"notext",corners:!0,shadow:!0}),e('<h1 class="ui-title">'+(!1!==n.headerText?n.headerText:"")+"</h1>").appendTo(t.sdHeader),t.sdHeader.appendTo(t.sdIntContent)),"blank"===n.mode?(!0===n.blankContent&&(!0===n.blankContentAdopt?n.blankContent=t.element.children():n.blankContent=t.element.html()),e(n.blankContent).appendTo(t.sdIntContent)):"button"===n.mode&&t._makeButtons().appendTo(t.sdIntContent),t.sdIntContent.appendTo(t.displayAnchor.parent()),t.dialogPage.appendTo(e.mobile.pageContainer).page().css("minHeight","0px").css("zIndex",n.zindex),!0===n.animate&&t.dialogPage.addClass(n.transition),t.screen=e("<div>",{class:"ui-simpledialog-screen ui-simpledialog-hidden"}).css("z-index",n.zindex-1).appendTo(t.displayAnchor.parent()).bind(n.clickEvent,(function(e){n.forceInput||t.close(),e.preventDefault()})),n.showModal&&t.screen.addClass("ui-simpledialog-screen-modal"),e(document).bind("simpledialog."+t.internalID,{widget:t},(function(e,n){t._eventHandler(e,n)}))},_makeButtons:function(){var t=this,n=t.options,i=e("<div></div>"),o=e("<div class='ui-simpledialog-controls'><input class='ui-simpledialog-input ui-input-text ui-shadow-inset ui-corner-all ui-body-"+n.themeInput+"' type='"+(!0===n.buttonPassword?"password":"text")+"' value='"+(!1!==n.buttonInputDefault?n.buttonInputDefault.replace('"',"&#34;").replace("'","&#39;"):"")+"' name='pickin' /></div>"),a=e("<div>",{class:"ui-simpledialog-controls"});return!1!==n.buttonPrompt&&(t.buttonPromptText=e("<p class='ui-simpledialog-subtitle'>"+n.buttonPrompt+"</p>").appendTo(i)),!1!==n.buttonInput&&(e.mobile.sdLastInput="",o.appendTo(i),o.find("input").bind("change",(function(){e.mobile.sdLastInput=o.find("input").first().val(),t.thisInput=o.find("input").first().val()}))),a.appendTo(i),t.butObj=[],e.each(n.buttons,(function(i,o){o=e.isFunction(o)?{click:o}:o,o=e.extend({text:i,id:i+t.internalID,theme:n.themeButtonDefault,icon:"check",iconpos:"left",corners:"true",shadow:"true",args:[],close:!0},o),t.butObj.push(e("<a href='#'>"+i+"</a>").appendTo(a).attr("id",o.id).buttonMarkup({theme:o.theme,icon:o.icon,iconpos:o.iconpos,corners:o.corners,shadow:o.shadow}).unbind("vclick click").bind(n.clickEvent,(function(){n.buttonInput&&t.sdIntContent.find("input [name=pickin]").trigger("change");var i=o.click.apply(t,e.merge(arguments,o.args));!1!==i&&!0===o.close&&t.close()})))})),i},_getCoords:function(t){var n=e.mobile.activePage.width(),i=e(window).scrollTop(),o=e(window).height(),a=t.sdIntContent.innerWidth(),s=t.sdIntContent.outerHeight(),d={high:e(window).height(),width:e.mobile.activePage.width(),fullTop:e(window).scrollTop(),fullLeft:e(window).scrollLeft(),winTop:i+(!1!==t.options.top?t.options.top:o/2-s/2),winLeft:!1!==t.options.left?t.options.left:n/2-a/2};return d.winTop<45&&(d.winTop=45),d},_orientChange:function(e){var t=e.data.widget,n=e.data.widget.options,i=e.data.widget._getCoords(e.data.widget);if(e.stopPropagation(),!0===t.isDialog)return!0;!0===n.fullScreen&&(i.width<400||!0===n.fullScreenForce)?t.sdIntContent.css({border:"none",position:"absolute",top:i.fullTop,left:i.fullLeft,height:i.high,width:i.width,maxWidth:i.width}).removeClass("ui-simpledialog-hidden"):t.sdIntContent.css({position:"absolute",top:i.winTop,left:i.winLeft}).removeClass("ui-simpledialog-hidden")},repos:function(){var e={data:{widget:this},stopPropagation:function(){return!0}};this._orientChange(e)},open:function(){var t=this,n=this.options,i=this._getCoords(this);t.sdAllContent.find(".ui-btn-active").removeClass("ui-btn-active"),t.sdIntContent.delegate("[rel=close]",n.clickEvent,(function(e){e.preventDefault(),t.close()})),!0===n.dialogAllow&&i.width<400||n.dialogForce?(t.isDialog=!0,"blank"===n.mode&&t.sdIntContent.find("select").each((function(){e(this).jqmData("nativeMenu",!0)})),t.displayAnchor.parent().unbind("pagehide.remove"),t.sdAllContent.append(t.sdIntContent),t.sdAllContent.trigger("create"),!1!==n.headerText&&(t.sdHeader.find("h1").appendTo(t.dialogPage.find("[data-role=header]")),t.sdIntContent.find(".ui-header").empty().removeClass()),!0===n.headerClose?t.dialogPage.find(".ui-header a").bind("click",(function(){setTimeout("$.mobile.sdCurrentDialog.destroy();",1e3)})):t.dialogPage.find(".ui-header a").remove(),t.sdIntContent.removeClass().css({top:"auto",width:"auto",left:"auto",marginLeft:"auto",marginRight:"auto",zIndex:n.zindex}),e.mobile.changePage(t.dialogPage,{transition:!0===n.animate?n.transition:"none"})):(t.isDialog=!1,t.selects=[],!1===n.fullScreen&&(!0===n.showModal&&!0===n.animate?t.screen.fadeIn("slow"):t.screen.removeClass("ui-simpledialog-hidden")),t.sdIntContent.addClass("ui-overlay-shadow in").css("zIndex",n.zindex).trigger("create"),!0===n.fullScreen&&(i.width<400||!0===n.fullScreenForce)?t.sdIntContent.removeClass("ui-simpledialog-container").css({border:"none",position:"absolute",top:i.fullTop,left:i.fullLeft,height:i.high,width:i.width,maxWidth:i.width}).removeClass("ui-simpledialog-hidden"):t.sdIntContent.css({position:"absolute",top:i.winTop,left:i.winLeft}).removeClass("ui-simpledialog-hidden"),e(document).bind("orientationchange.simpledialog",{widget:t},(function(e){t._orientChange(e)})),!0===n.resizeListener&&e(window).bind("resize.simpledialog",{widget:t},(function(e){t._orientChange(e)}))),e.isFunction(n.callbackOpen)&&n.callbackOpen.apply(t,n.callbackOpenArgs)},close:function(){var t,n=this.options;if(e.isFunction(this.options.callbackClose)&&!1===this.options.callbackClose.apply(this,this.options.callbackCloseArgs))return!1;this.isDialog?(e(this.dialogPage).dialog("close"),this.sdIntContent.addClass("ui-simpledialog-hidden"),this.sdIntContent.appendTo(this.displayAnchor.parent()),1!=e.mobile.activePage.jqmData("page").options.domCache&&e.mobile.activePage.is(":jqmData(external-page='true')")&&e.mobile.activePage.bind("pagehide.remove",(function(){e(this).remove()}))):(!0===this.options.showModal&&!0===this.options.animate?this.screen.fadeOut("slow"):this.screen.addClass("ui-simpledialog-hidden"),this.sdIntContent.addClass("ui-simpledialog-hidden").removeClass("in"),e(document).unbind("orientationchange.simpledialog"),!0===this.options.resizeListener&&e(window).unbind("resize.simpledialog")),"blank"===n.mode&&!1!==n.blankContent&&!0===n.blankContentAdopt&&(this.element.append(n.blankContent),n.blankContent=!0),!0===this.isDialog||!0===this.options.animate?setTimeout((t=this,function(){t.destroy()}),1e3):this.destroy()},destroy:function(){var t=this.element;"blank"===this.options.mode&&e.mobile.sdCurrentDialog.sdIntContent.find("select").each((function(){0==e(this).data("nativeMenu")&&(e(this).data("selectmenu").menuPage.remove(),e(this).data("selectmenu").screen.remove(),e(this).data("selectmenu").listbox.remove())})),e(this.sdIntContent).remove(),e(this.dialogPage).remove(),e(this.screen).remove(),e(document).unbind("simpledialog."+this.internalID),delete e.mobile.sdCurrentDialog,e.Widget.prototype.destroy.call(this),!0===this.options.safeNuke&&0===e(t).parents().length&&0===e(t).contents().length&&t.remove()},updateBlank:function(t){var n=this.options;this.sdIntContent.empty(),!1===n.headerText&&!1===n.headerClose||(this.sdHeader=e('<div class="ui-header ui-bar-'+n.themeHeader+'"></div>'),!0===n.headerClose&&e("<a class='ui-btn-left' rel='close' href='#'>Close</a>").appendTo(this.sdHeader).buttonMarkup({theme:n.themeHeader,icon:"delete",iconpos:"notext",corners:!0,shadow:!0}),e('<h1 class="ui-title">'+(!1!==n.headerText?n.headerText:"")+"</h1>").appendTo(this.sdHeader),this.sdHeader.appendTo(this.sdIntContent)),e(t).appendTo(this.sdIntContent),this.sdIntContent.trigger("create"),e(document).trigger("orientationchange.simpledialog")},_init:function(){this.open()}})}(jQuery);